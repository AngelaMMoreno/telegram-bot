version: "3.8"

services:
  quizbot:
    build: .
    environment:
      TOKEN: ${TOKEN}
      SERVIR_ARCHIVOS_PUBLICOS: ${SERVIR_ARCHIVOS_PUBLICOS:-1}
      PUERTO_ARCHIVOS_PUBLICOS: ${PUERTO_ARCHIVOS_PUBLICOS:-8000}
      URL_PUBLICA_ARCHIVOS: ${URL_PUBLICA_ARCHIVOS:-https://aprentix.es}
      RUTA_ARCHIVOS_PUBLICOS: /app/users/publicos
    restart: unless-stopped
    volumes:
      - datos_usuarios:/app/users
      - /mnt/data/ficheros:/app/users/publicos
    labels:
      - "traefik.enable=true"

      # Middleware: redirige HTTP → HTTPS permanentemente
      - "traefik.http.middlewares.redireccion_https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redireccion_https.redirectscheme.permanent=true"

      # Router HTTPS: sirve ficheros en aprentix.es (con y sin www)
      - "traefik.http.routers.archivos.rule=Host(`${DOMINIO_PUBLICO_ARCHIVOS:-aprentix.es}`) || Host(`${DOMINIO_PUBLICO_ARCHIVOS_WWW:-www.aprentix.es}`)"
      - "traefik.http.routers.archivos.entrypoints=websecure"
      - "traefik.http.routers.archivos.tls=true"
      - "traefik.http.routers.archivos.tls.certresolver=letsencrypt"
      - "traefik.http.routers.archivos.service=archivos"
      - "traefik.http.services.archivos.loadbalancer.server.port=${PUERTO_ARCHIVOS_PUBLICOS:-8000}"

      # Router HTTP: redirige aprentix.es → HTTPS
      - "traefik.http.routers.archivos_http.rule=Host(`${DOMINIO_PUBLICO_ARCHIVOS:-aprentix.es}`) || Host(`${DOMINIO_PUBLICO_ARCHIVOS_WWW:-www.aprentix.es}`)"
      - "traefik.http.routers.archivos_http.entrypoints=web"
      - "traefik.http.routers.archivos_http.middlewares=redireccion_https"
      - "traefik.http.routers.archivos_http.service=archivos"

    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true

volumes:
  datos_usuarios:
